name: Sync upstream

on:
  workflow_dispatch:   # æ‰‹åŠ¨è§¦å‘
  schedule:            # âœ… æ–°å¢å®šæ—¶ä»»åŠ¡
    - cron: '0 2 * * *'  # æ¯å¤©åŒ—äº¬æ—¶é—´å‡Œæ™¨ 2:00

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch upstream
        run: |
          git remote add upstream https://github.com/huangxd-/danmu_api.git || true
          git fetch upstream

      - name: Try merge
        id: merge
        run: |
          echo "ğŸ”„ æ­£åœ¨å°è¯•åˆå¹¶ä¸Šæ¸¸æ›´æ–°..."
          if git merge upstream/main --no-edit; then
            echo "merge_result=success" >> $GITHUB_ENV
          else
            echo "merge_result=conflict" >> $GITHUB_ENV
          fi

      - name: Push if success
        if: env.merge_result == 'success'
        run: |
          echo "âœ… åŒæ­¥æˆåŠŸï¼Œæ­£åœ¨æ¨é€..."
          git push origin main

      - name: Create PR if conflict
        if: env.merge_result == 'conflict'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: sync upstream (conflicts need resolution)"
          title: "âš ï¸ Sync upstream - conflicts detected"
          body: "GitHub Actions è‡ªåŠ¨åŒæ­¥æ—¶å‘ç°å†²çªï¼Œè¯·æ‰‹åŠ¨è§£å†³ã€‚"
          branch: sync-upstream